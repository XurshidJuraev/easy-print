import React, { useEffect, useLayoutEffect, useState } from 'react'
import HeaderMain from '../../components/header'
import AdvantageMain from '../../components/advantage'
import FooterMain from '../../components/footer'
import show_right from '../../layouts/icons/show_right.svg'
import show_left from '../../layouts/icons/show_left.svg'
import './main.css'
import 'react-toastify/dist/ReactToastify.css';
import { NavLink, useNavigate, useParams } from 'react-router-dom'
import axios from 'axios'
import { ToastContainer, toast } from 'react-toastify';

function ShowDetail() {
  const params = useParams()
  const [trashCardData, setTrashCardData] = useState([]);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [dataBeck, setDataBeck] = useState([]);
  const [selectedColorIndex, setSelectedColorIndex] = useState(0);
  const token = localStorage.getItem('token');
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const [sizeOptions, setSizeOptions] = useState([]);
  const [data, setData] = useState([]);
  const [colorOptions, setColorOptions] = useState([]);
  const [colorArray, setColorArray] = useState([]);
  const [idCounter, setIdCounter] = useState(1);
  const [sizeArray, setSizeArray] = useState([]);
  const [selectedCard, setSelectedCard] = useState(null);
  const [selectedSizeIndex, setSelectedSizeIndex] = useState(0);
  const [displayedItems, setDisplayedItems] = useState(8);
  const [modalData, setModalData] = useState([]);
  const [count, setCount] = useState(1);
  const [selectedSize, setSelectedSize] = useState('s');
  const [selectedColor, setSelectedColor] = useState('#D9CCC6');

  useEffect(() => {
    localStorage.setItem('selectedCategory', params.id);
  })

  if (params.id !== localStorage.getItem('selectedCategory')) {
    setTimeout(() => {
      window.location.reload();
    }, 300);
  }

  const navigate = useNavigate();

  useEffect(() => {
    window.scrollTo(0, 0);
  }, []);

  // useEffect(() => {
  //   if (dataBeck.size_by_color && dataBeck.size_by_color.length > 0) {
  //     const sizes = dataBeck.size_by_color.flatMap((size) => size.sizes.map((s) => s.name));
  //     setSizeOptions(sizes);
  //   }

  //   if (dataBeck.color_by_size && dataBeck.color_by_size.length > 0) {
  //     const colors = dataBeck.color_by_size.flatMap((color) => color.color.map((c) => c.name));
  //     setColorOptions(colors);
  //   }
  // }, [dataBeck]);

  useEffect(() => {
    if (dataBeck.size_by_color && dataBeck.size_by_color.length > 0) {
      const sizes = dataBeck.size_by_color.flatMap((size) => size.sizes.map((s) => s.name));
      setSizeOptions(sizes);
    }
  
    if (dataBeck.color_by_size && dataBeck.color_by_size.length > 0) {
      const colors = dataBeck.color_by_size.flatMap((color) => color.color.map((c) => c.name));
      setColorOptions(colors);
    }
  
    // Avvalgi tanlangan sizni indexini tekshirib, agar u tuzatilmasa, birinchi sizni tanlang
    const selectedSizeIndex = sizeOptions.findIndex((size) => size === sizeOptions[selectedSizeIndex]) || 0;
  
    // Agar tanlangan size indeksi o'zgarib qolsa, yangi sizni ranglarni o'zgartirish
    if (selectedSizeIndex !== selectedSizeIndex) {
      setSelectedSizeIndex(selectedSizeIndex);
  
      // Yangi sizni indexiga qarab colorArray ni yangilash
      const selectedSizeData = dataBeck.size_by_color[selectedSizeIndex];
      setColorArray(selectedSizeData?.color || []);
    }
  }, [dataBeck, sizeOptions, selectedSizeIndex]);

  const handleNextImage = () => {
    if (dataBeck.images && dataBeck.images.length > 0) {
      setCurrentImageIndex((prevIndex) => (prevIndex + 1) % dataBeck.images.length);
    }
  };

  const handlePrevImage = () => {
    if (dataBeck.images && dataBeck.images.length > 0) {
      setCurrentImageIndex((prevIndex) => (prevIndex - 1 + dataBeck.images.length) % dataBeck.images.length);
    }
  };

  useEffect(() => {
    const savedCards = JSON.parse(localStorage.getItem('trashCard'));
    if (savedCards) {
      setTrashCardData(savedCards);
    }
  }, []);

  useEffect(() => {
    addToBasket(selectedProduct);
  }, [selectedProduct]);

  useEffect(() => {
    axios.get(`${process.env.REACT_APP_TWO}/product/show/warehouse_product?warehouse_product_id=${params.id}`, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/json"
      }
    }).then((response) => {
      setColorArray(response.data.data.color_by_size);
      setSizeArray(response.data.data.size_by_color);
      setDataBeck(response.data.data);
    }).catch((error) => {
      toast.error('Xatolik yuz berdi. Iltimos qaytadan urining!');
    });    
  }, []);

  useEffect(() => {
    axios.get(`${process.env.REACT_APP_TWO}/get-warehouses`, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/json"
      }
    }).then((response) => {
      setData(response.data);
    }).catch((error) => {
      toast.error('Xatolik yuz berdi. Iltimos qaytadan urining!');
    });    
  }, []);

  function openModal(cardData) {
    setSelectedCard(cardData);
    const modal = document.getElementById('exampleModal');
    if (modal) {
      modal.style.display = 'block';
    }
    
    axios.get(`${process.env.REACT_APP_TWO}/product/show/warehouse_product?warehouse_product_id=${cardData.id}`, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/json"
      }
    }).then((response) => {
      setModalData(response.data.data);
    }).catch((error) => {
      toast.error('Xatolik yuz berdi. Iltimos qaytadan urining!');
    });
  }

  const handleShowMore = () => {
    if (data.data && data.data.warehouse_product_list.length > displayedItems) {
      setDisplayedItems((prevDisplayedItems) => prevDisplayedItems + 8);
    }
  };

  const addToBasket = (productData) => {
    if (productData) {
      const selectedColor = dataBeck.color_by_size[selectedSizeIndex];
      const selectedSize = dataBeck.size_by_color[selectedColorIndex];
  
      const colorId = selectedColor.color[selectedColorIndex].id;
      const sizeId = selectedSize.sizes[selectedSizeIndex].id;
  
      var myHeaders = new Headers();
      myHeaders.append("language", "uz");
      myHeaders.append("Accept", "application/json");
      myHeaders.append("Authorization", `Bearer ${token}`);
  
      var formdata = new FormData();
      formdata.append("warehouse_product_id", productData.id);
      formdata.append("quantity", 1);
      formdata.append("color_id", colorId);
      formdata.append("size_id", sizeId);
      formdata.append("price", productData.price);
      formdata.append("discount", dataBeck.discount ? dataBeck.discount : '0');
  
      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: formdata,
        redirect: 'follow'
      };

      const basketData = {
        warehouse_product_id: productData.id,
        quantity: 1,
        color_id: colorId,
        size_id: sizeId,
        price: productData.price,
        discount: dataBeck.discount ? dataBeck.discount : '0'
      };

      localStorage.setItem('basket', JSON.stringify(basketData));
  
      fetch("http://admin.easyprint.uz/api/order/set-warehouse", requestOptions)
        .then(response => response.json())
        .then(result => {
          if (result.status === true) {
            toast.success('Товар добавлен');
          } else {
            if (result.message === "Unauthenticated.") {
              const basketData = {
                warehouse_product_id: productData.id,
                quantity: 1,
                color_id: colorId,
                size_id: sizeId,
                price: productData.price,
                discount: dataBeck.discount ? dataBeck.discount : '0'
              };
  
              localStorage.setItem('basket', JSON.stringify(basketData));
  
              toast.error('Вы еще не зарегистрированы. Товар добавлен в корзину.');
            } else {
              toast.error('Товар не добавлен');
            }
          }
        })
        .catch(error => {
          toast.error('Товар не добавлен');
        });
    }
  };
  
  useEffect(() => {
    addToBasket(selectedProduct);
  }, [selectedProduct]);

  function handleCardClick(imageSrc, name, price) {
    const currentTime = new Date();
    const clickedCardData = {
      id: idCounter,
      count: count,
      imageSrc,
      selectedSize,
      selectedColor,
      name,
      price,
      timestamp: currentTime.toString(),
    };
  
    if (count > 1) {
      setCount(count - 1);
    }
  
    setIdCounter((prevId) => prevId + 1);
  
    setTrashCardData((prevData) => [...prevData, clickedCardData]);
  
    localStorage.setItem('trashCard', JSON.stringify([...trashCardData, clickedCardData]));
  
    // toast.success(`${name} в корзину`, {
    //   position: toast.POSITION.TOP_RIGHT,
    //   autoClose: 2000,
    // });
  }  

  return (
    <div>
      <HeaderMain trashCardData={trashCardData} />
      <ToastContainer />

      <div className="container">
        <h3 className='show_detail_title mb-3'>Детали товара</h3>

        <div className="card_detail">
          <div className="img_card_detail">
            {dataBeck.images && dataBeck.images.length > 0 && (
              <img src={dataBeck.images[currentImageIndex]} alt={dataBeck.name ? dataBeck.name : 'Название отсутствует или не найден'} />
            )}

            <div className="d-flex justify-content-between" style={{width: '439.014px', marginLeft: '-50px', marginTop: '450px'}}>
              <button style={{ backgroundColor: 'transparent', border: 'none' }} onClick={handleNextImage}>
                <img style={{ width: '48px', height: '48px' }} src={show_right} alt="show_right" />
              </button>

              <button style={{ backgroundColor: 'transparent', border: 'none' }} onClick={handlePrevImage}>
                <img style={{ width: '48px', height: '48px' }} src={show_left} alt="show_left" />
              </button>
            </div>
          </div>

          <div style={{marginLeft: '48px'}}>
            <h2 className='show_detail_name'>{dataBeck.name ? dataBeck.name : 'Название отсутствует или не найден'}</h2>

            <p className='show_detail_description'>{dataBeck.description ? dataBeck.description : 'Описание отсутствует или не найден'}</p>

            <p className='show_detail_price'>
              {dataBeck.price_discount ? 
                <div>
                  {Number(dataBeck.price_discount).toLocaleString('ru-RU')} сум
                  <del className='show_detail_price_discount'>
                    {Number(dataBeck.price).toLocaleString('ru-RU')} сум
                  </del>
                </div>
                : 
                <div>
                  {dataBeck.price ? `${Number(dataBeck.price).toLocaleString('ru-RU')} сум` : 'Цена отсутствует или не найден'}
                </div>
              }
            </p>

            <div className="d-flex">
              <div style={{marginRight: '83px'}}>
                <p className='show_detail_size'>Размер</p>
                {/* <select 
                  className='show_detail_option' 
                  value={sizeOptions[selectedSizeIndex]}
                  onChange={(e) => {
                    const index = sizeOptions.findIndex((size) => size === e.target.value);
                    setSelectedSizeIndex(index);
                  }}
                  >
                  {sizeArray[selectedSizeIndex]?.sizes.map((size) => (
                    <option key={size.id} value={size.name}>{size.name}</option>
                  ))}
                </select> */}
                <select
                  className='show_detail_option'
                  value={sizeOptions[selectedSizeIndex]}
                  onChange={(e) => {
                    const index = sizeOptions.findIndex((size) => size === e.target.value);
                    setSelectedSizeIndex(index);

                    // Update colorArray based on the selected size
                    const selectedSizeData = dataBeck.size_by_color[index];
                    setSizeArray(selectedSizeData?.color || []);
                  }}
                >
                  {sizeArray[selectedSizeIndex]?.sizes.map((size) => (
                    <option key={size.id} value={size.name}>{size.name}</option>
                  ))}
                </select>
              </div>

              <div>
                <p className='show_detail_size'>Цвет</p>

                <div className="d-flex">
                  {colorArray[selectedSizeIndex]?.color.map((color, index) => (
                    <div
                      key={index}
                      className="color_border me-2"
                      style={{borderColor: selectedColorIndex === index ? '#4D4D4D' : '#E6E6E6', cursor: 'pointer'}}
                      onClick={() => setSelectedColorIndex(index)}
                    >
                      <div className="color" style={{backgroundColor: color.code}}></div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="d-flex">
              <button onClick={() => addToBasket(dataBeck)} className='add_basket_btn' style={{width: '266px', height: '56px', marginTop: '18px', marginLeft: '0px', padding: '15px 18px', marginRight: '12px'}}>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M19.5 7H17C17 5.67392 16.4732 4.40215 15.5355 3.46447C14.5979 2.52678 13.3261 2 12 2C10.6739 2 9.40215 2.52678 8.46447 3.46447C7.52678 4.40215 7 5.67392 7 7H4.5C3.83696 7 3.20107 7.26339 2.73223 7.73223C2.26339 8.20107 2 8.83696 2 9.5L2 17.8333C2.00132 18.938 2.44073 19.997 3.22185 20.7782C4.00296 21.5593 5.062 21.9987 6.16667 22H17.8333C18.938 21.9987 19.997 21.5593 20.7782 20.7782C21.5593 19.997 21.9987 18.938 22 17.8333V9.5C22 8.83696 21.7366 8.20107 21.2678 7.73223C20.7989 7.26339 20.163 7 19.5 7ZM12 3.66667C12.8841 3.66667 13.7319 4.01786 14.357 4.64298C14.9821 5.2681 15.3333 6.11594 15.3333 7H8.66667C8.66667 6.11594 9.01786 5.2681 9.64298 4.64298C10.2681 4.01786 11.1159 3.66667 12 3.66667ZM20.3333 17.8333C20.3333 18.4964 20.0699 19.1323 19.6011 19.6011C19.1323 20.0699 18.4964 20.3333 17.8333 20.3333H6.16667C5.50363 20.3333 4.86774 20.0699 4.3989 19.6011C3.93006 19.1323 3.66667 18.4964 3.66667 17.8333V9.5C3.66667 9.27899 3.75446 9.06702 3.91074 8.91074C4.06702 8.75446 4.27899 8.66667 4.5 8.66667H7V10.3333C7 10.5543 7.0878 10.7663 7.24408 10.9226C7.40036 11.0789 7.61232 11.1667 7.83333 11.1667C8.05435 11.1667 8.26631 11.0789 8.42259 10.9226C8.57887 10.7663 8.66667 10.5543 8.66667 10.3333V8.66667H15.3333V10.3333C15.3333 10.5543 15.4211 10.7663 15.5774 10.9226C15.7337 11.0789 15.9457 11.1667 16.1667 11.1667C16.3877 11.1667 16.5996 11.0789 16.7559 10.9226C16.9122 10.7663 17 10.5543 17 10.3333V8.66667H19.5C19.721 8.66667 19.933 8.75446 20.0893 8.91074C20.2455 9.06702 20.3333 9.27899 20.3333 9.5V17.8333Z" fill="white"/>
                </svg>
                <span>Добавить в корзину</span>
              </button>

              <button className='hero_button' style={{width: '236px', height: '56px', marginTop: '18px', marginLeft: '0px', padding: '15px 18px'}}>
                <span>Заказать сейчас</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 25 24" fill="none">
                  <path d="M22.5 13.0039C22.4951 12.4774 22.2832 11.9741 21.91 11.6029L17.62 7.29979C17.4326 7.11341 17.1792 7.00879 16.915 7.00879C16.6508 7.00879 16.3974 7.11341 16.21 7.29979C16.1163 7.39282 16.0419 7.5035 15.9911 7.62545C15.9403 7.7474 15.9142 7.8782 15.9142 8.0103C15.9142 8.14241 15.9403 8.27321 15.9911 8.39516C16.0419 8.5171 16.1163 8.62778 16.21 8.72081L19.5 12.0032H3.5C3.23478 12.0032 2.98043 12.1086 2.79289 12.2963C2.60536 12.484 2.5 12.7385 2.5 13.0039C2.5 13.2693 2.60536 13.5238 2.79289 13.7115C2.98043 13.8992 3.23478 14.0046 3.5 14.0046H19.5L16.21 17.297C16.0217 17.4841 15.9154 17.7384 15.9144 18.004C15.9135 18.2695 16.018 18.5246 16.205 18.713C16.392 18.9015 16.6461 19.0078 16.9115 19.0088C17.1768 19.0097 17.4317 18.9051 17.62 18.718L21.91 14.4149C22.2856 14.0413 22.4978 13.5339 22.5 13.0039Z" fill="white"/>
                </svg>
              </button>
            </div>

            <div style={{display: 'flex', marginTop: '32px'}}>
              <p className='show_detail_author'>Автор:</p>
              <a className='show_detail_author_name' href="#">{dataBeck.company_name}</a>
            </div>

            <div>
              <h3 className='show_detail_title_info mb-3'>Детали</h3>

              <div className="d-flex">
                <div>
                  <p className='show_detail_title_info-text'>Материал:</p>
                  <p className='show_detail_title_info-text'>Состав материала:</p>
                  <p className='show_detail_title_info-text'>Страна-производитель:</p>
                </div>

                <div style={{marginLeft: '32px'}}>
                  <p className='show_detail_title_info-text' style={{color: '#1A1A1A'}}>{dataBeck.material_name ? dataBeck.material_name : 'Нет данных'}</p>
                  <p className='show_detail_title_info-text' style={{color: '#1A1A1A'}}>{dataBeck.material_composition ? dataBeck.material_composition : 'Нет данных'}</p>
                  <p className='show_detail_title_info-text' style={{color: '#1A1A1A'}}>{dataBeck.manufacturer_country ? dataBeck.manufacturer_country : 'Нет данных'}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <AdvantageMain />
      <FooterMain />
    </div>
  );
}

export default ShowDetail;